{% extends "base.html" %}
{% block title %}学習ログ{% endblock %}
{% block content %}
<h1>学習ログ</h1>

<form method="POST" class="log-form">
    <input type="date" name="date" value="{{ today }}">
    <input type="number" name="minutes" min="0" placeholder="分" required>
    <input type="text" name="subject" placeholder="科目（例: Math）" required>
    <input type="text" name="note" placeholder="メモ（任意）">
    <button type="submit">追加</button>
</form>


<div class="tabs">
  <button class="tab" data-range="week">今週</button>
  <button class="tab" data-range="month">今月</button>
</div>

<div class="period-nav">
  <button id="prevBtn">← 前へ</button>
  <span id="periodText"></span>
  <button id="nextBtn">次へ →</button>
</div>

<div class="chart-wrap">
  <canvas id="studyChart"></canvas>
  <p class="total">合計：<span id="totalMin">0</span> 分</p>
</div>

<h2>最近の記録</h2>
<ul class="recent-list">
  {% for r in recent %}
  <li>{{ r.date }} / {{ r.subject }} / {{ r.minutes }}分 {% if r.note %}- {{ r.note }}{% endif %}</li>
  {% endfor %}
</ul>


<script>
  
let chart;
let currentRange = 'week';
let currentOffset = 0;

function renderChart(labels, values) {
  const ctx = document.getElementById('studyChart').getContext('2d');
  const cfg = {
    type: 'bar',
    data: {
      labels,
      datasets: [{ label: '学習時間(分)', data: values }]
    },
    options: {
      responsive: true,
      scales: { x: { grid: { display:false } }, y: { beginAtZero:true } }
    }
  };

  if (!chart) chart = new Chart(ctx, cfg);
  else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
    chart.update();
  }
}

async function load(range = currentRange, offset = currentOffset) {
  currentRange = range;
  currentOffset = offset;

  const res = await fetch(`/api/stats?range=${range}&offset=${offset}`);
  if (!res.ok) {
    console.error('API error', res.status);
    return;
  }
  const data = await res.json();

  document.getElementById('totalMin').textContent = data.total ?? 0;
  const periodText = document.getElementById('periodText');
  if (periodText) periodText.textContent = data.period_label;

  const totalLabel = document.getElementById('totalLabel');
  if (totalLabel) {
    const label = data.range === 'month' ? '今月合計' : '今週合計';
    totalLabel.textContent = `${label}（${data.start}〜${data.end}）`;
  }

  const nextBtn = document.getElementById('nextBtn');
  if (nextBtn) nextBtn.disabled = (currentOffset >= 0);

  renderChart(data.labels, data.values);
}

document.querySelectorAll('.tab').forEach(btn => {
  btn.addEventListener('click', () => load(btn.dataset.range, 0));
});

document.getElementById('prevBtn').addEventListener('click', () => {
  load(currentRange, currentOffset - 1);
});
document.getElementById('nextBtn').addEventListener('click', () => {
  if (currentOffset < 0) load(currentRange, currentOffset + 1);
});

document.addEventListener('DOMContentLoaded', () => load('week', 0));

</script>

{% endblock %}
